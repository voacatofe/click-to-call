version: '3.8'

services:
  voip:
    volumes:
      # Em produção, os volumes de configuração e sons são removidos
      # para garantir que o container use apenas os arquivos da imagem.
      - asterisk_recordings:/var/spool/asterisk/monitor
      - asterisk_certs:/etc/asterisk/keys

  backend:
    environment:
      - NODE_ENV=production
    build:
      context: .
      dockerfile: apps/api/Dockerfile
      # Otimização: Cache de build para produção
      cache_from:
        - ${REGISTRY:-minhaorg}/meu-app-backend:latest
    image: ${REGISTRY:-minhaorg}/meu-app-backend:latest

  frontend:
    environment:
      - NODE_ENV=production
    build:
      context: .
      dockerfile: apps/web/Dockerfile
      # Otimização: Cache de build para produção
      cache_from:
        - ${REGISTRY:-minhaorg}/meu-app-frontend:latest
      args:
        # As variáveis de build devem ser passadas aqui também,
        # idealmente de um .env de produção.
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
        NEXT_PUBLIC_ASTERISK_HOST: ${NEXT_PUBLIC_ASTERISK_HOST}
        NEXT_PUBLIC_ASTERISK_WSS_PORT: ${NEXT_PUBLIC_ASTERISK_WSS_PORT}
        NEXT_PUBLIC_AGENT_PASSWORD: ${NEXT_PUBLIC_AGENT_PASSWORD}
        NEXT_PUBLIC_FORCE_PROTOCOL: ${NEXT_PUBLIC_FORCE_PROTOCOL}
        NEXT_PUBLIC_AGENT_ID: ${NEXT_PUBLIC_AGENT_ID}
        NEXT_PUBLIC_ASTERISK_REALM: ${NEXT_PUBLIC_ASTERISK_REALM}
        NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${NEXT_PUBLIC_SUPABASE_ANON_KEY}
    image: ${REGISTRY:-minhaorg}/meu-app-frontend:latest 