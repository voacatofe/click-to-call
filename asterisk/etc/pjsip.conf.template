;================================================================================
; pjsip.conf - Configuração PJSIP WSS-Only
; Configuração segura usando apenas WebSocket Secure (WSS)
;================================================================================

;--------------------------------------------------------------------------------
; Configurações Globais do PJSIP
;--------------------------------------------------------------------------------
[global]
type=global
user_agent=ClickToCall PBX
default_realm=clicktocall.local

;--------------------------------------------------------------------------------
; Transporte WebSocket Seguro (WSS)
; Define como o Asterisk escuta por conexões WebRTC.
;--------------------------------------------------------------------------------
[transport-wss]
type=transport
protocol=wss
bind=0.0.0.0:8089
external_media_address=${EXTERNAL_IP}
external_signaling_address=${EXTERNAL_IP}

;--------------------------------------------------------------------------------
; TEMPLATES DE CONFIGURAÇÃO
; Usamos templates para evitar repetição e facilitar a manutenção.
; O "!" indica que esta seção é um template e não um objeto real.
;--------------------------------------------------------------------------------

; Template para Autenticação
; Define o tipo de autenticação (usuário/senha).
[auth-template](!)
type=auth
auth_type=userpass

; Template para Address of Record (AOR)
; Define como um ramal pode ser alcançado.
[aor-template](!)
type=aor
max_contacts=1
remove_existing=yes ; Se o agente se registrar de um novo local, o antigo é removido.

; Template para Endpoint
; Define as características técnicas de um ramal (codecs, WebRTC, etc).
[endpoint-template](!)
type=endpoint
context=from-internal ; Para onde vão as chamadas deste ramal no dialplan.
disallow=all
allow=opus          ; Codec de áudio de alta qualidade, ideal para WebRTC.
allow=ulaw          ; Codec de áudio padrão, para compatibilidade.
rtp_symmetric=yes   ; Essencial para NAT - envia mídia de volta para a origem.

; Configurações WebRTC essenciais
transport=transport-wss
media_encryption=dtls
dtls_verify=fingerprint
dtls_setup=actpass
dtls_cert_file=/etc/asterisk/keys/asterisk.crt
dtls_private_key=/etc/asterisk/keys/asterisk.key
ice_support=yes
use_avpf=yes
force_rport=yes
rtcp_mux=yes
rewrite_contact=yes
; Configurações adicionais para melhorar o áudio
direct_media=no
media_address=${EXTERNAL_IP}

;--------------------------------------------------------------------------------
; DEFINIÇÃO DO RAMAL DO AGENTE: agent-1001
; Criamos as seções concretas a partir dos templates.
;--------------------------------------------------------------------------------

; Autenticação para o agente 1001
[agent-1001-auth](auth-template)
password=${AGENT_1001_PASSWORD}
username=agent-1001-wss

; Endereço (AOR) para o agente 1001
[agent-1001-wss](aor-template)
; Nenhuma configuração extra necessária, o nome da seção agora corresponde ao endpoint.

; Endpoint (configuração técnica) para o agente 1001
[agent-1001-wss](endpoint-template)
aors=agent-1001-wss  ; Associa este endpoint ao seu endereço (AOR) de mesmo nome.
auth=agent-1001-auth ; Associa este endpoint à sua autenticação. 